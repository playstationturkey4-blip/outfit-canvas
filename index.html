<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FOWOGES</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<style>
body{
  margin:0;
  font-family:'Inter',sans-serif;
  background:#0f0f0f;
  color:white;
  display:flex;
  flex-direction:column;
  height:100vh;
}

header{
  padding:20px;
  text-align:center;
  border-bottom:1px solid #1f1f1f;
}

.logo{
  font-family:'Playfair Display',serif;
  font-size:34px;
  letter-spacing:8px;
}

.nav{
  display:flex;
  justify-content:center;
  gap:25px;
  padding:10px;
  border-bottom:1px solid #1f1f1f;
}

.nav button{
  background:none;
  border:none;
  color:#aaa;
  font-size:14px;
  cursor:pointer;
}

.nav button.active{
  color:white;
  font-weight:600;
}

.screen{
  flex:1;
  display:none;
  padding:20px;
  overflow:auto;
}

.screen.active{
  display:block;
}

.hero{
  text-align:center;
  margin-top:80px;
}

.hero h1{
  font-size:48px;
  font-family:'Playfair Display',serif;
}

.hero p{
  color:#bbb;
  margin-top:15px;
}

.canvas{
  width:100%;
  height:60vh;
  background:#1a1a1a;
  border-radius:14px;
  position:relative;
  overflow:hidden;
  margin-bottom:15px;
}

.editable{
  position:absolute;
  cursor:move;
  border:2px dashed transparent;
}

.editable.active{
  border:2px dashed white;
}

.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

button.primary{
  padding:10px 16px;
  background:white;
  color:black;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.viewer-wrapper{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:20px;
  margin-top:30px;
}

.viewer{
  width:300px;
  height:500px;
  background:#1a1a1a;
  border-radius:14px;
  position:relative;
  overflow:hidden;
}
</style>
</head>

<body>

<header>
  <div class="logo">FOWOGES</div>
</header>

<div class="nav">
  <button onclick="switchScreen('home')" class="active">Главная</button>
  <button onclick="switchScreen('builder')">Создать</button>
  <button onclick="switchScreen('lookbook')">Образы</button>
</div>

<!-- Главная -->
<div id="home" class="screen active">
  <div class="hero">
    <h1>Redefine Your Wardrobe</h1>
    <p>Создавай цифровые образы и управляй стилем.</p>
  </div>
</div>

<!-- Создать -->
<div id="builder" class="screen">
  <h2>Создать образ</h2>
  <div class="canvas" id="canvas"></div>

  <div class="controls">
    <button class="primary" onclick="fileInput.click()">Добавить фото</button>
    <button class="primary" onclick="deleteActive()">Удалить</button>
    <button class="primary" onclick="saveOutfit()">Сохранить</button>
    <button class="primary" onclick="clearCanvas()">Очистить</button>
  </div>
</div>

<!-- Образы -->
<div id="lookbook" class="screen">
  <h2>Мои образы</h2>

  <div class="viewer-wrapper">
    <button onclick="prevOutfit()">←</button>
    <div id="viewer" class="viewer"></div>
    <button onclick="nextOutfit()">→</button>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" multiple style="display:none;">

<script>

let activeElement=null;
let savedOutfits=JSON.parse(localStorage.getItem("outfits"))||[];
let currentIndex=0;

const canvas=document.getElementById("canvas");
const viewer=document.getElementById("viewer");
const fileInput=document.getElementById("fileInput");

/* Переключение экранов */
function switchScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll(".nav button").forEach(b=>b.classList.remove("active"));
  document.querySelector(`[onclick="switchScreen('${id}')"]`).classList.add("active");
}

/* ===== ML НАСТРОЙКА ===== */

const selfieSegmentation = new SelfieSegmentation({
  locateFile: (file) => {
    return `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`;
  }
});

selfieSegmentation.setOptions({ modelSelection: 1 });
selfieSegmentation.onResults(onMLResults);

/* ===== ЗАГРУЗКА ===== */

fileInput.onchange=(e)=>{
  for(let file of e.target.files){
    const img=new Image();
    img.src=URL.createObjectURL(file);
    img.onload=()=>selfieSegmentation.send({image:img});
  }
};

/* ===== ML ОБРАБОТКА ===== */

function onMLResults(results){

  const tempCanvas=document.createElement("canvas");
  const ctx=tempCanvas.getContext("2d");

  tempCanvas.width=results.image.width;
  tempCanvas.height=results.image.height;

  ctx.drawImage(results.image,0,0);

  const imageData=ctx.getImageData(0,0,tempCanvas.width,tempCanvas.height);

  const maskCanvas=document.createElement("canvas");
  const maskCtx=maskCanvas.getContext("2d");

  maskCanvas.width=tempCanvas.width;
  maskCanvas.height=tempCanvas.height;
  maskCtx.drawImage(results.segmentationMask,0,0,tempCanvas.width,tempCanvas.height);

  const maskData=maskCtx.getImageData(0,0,tempCanvas.width,tempCanvas.height);

  for(let i=0;i<imageData.data.length;i+=4){
    const alpha=maskData.data[i];
    if(alpha<128){
      imageData.data[i+3]=0;
    }
  }

  ctx.putImageData(imageData,0,0);

  createElement(tempCanvas.toDataURL("image/png"));
}

/* ===== СОЗДАНИЕ ЭЛЕМЕНТА ===== */

function createElement(src){
  const el=document.createElement("div");
  el.classList.add("editable");
  el.dataset.x=100;
  el.dataset.y=100;
  el.dataset.scale=1;
  el.dataset.rotation=0;
  el.innerHTML=`<img src="${src}" style="width:150px;">`;
  updateTransform(el);
  canvas.appendChild(el);
  activate(el);
  makeDraggable(el);
}

function activate(el){
  document.querySelectorAll(".editable").forEach(e=>e.classList.remove("active"));
  el.classList.add("active");
  activeElement=el;
}

canvas.addEventListener("click",(e)=>{
  if(e.target===canvas){
    document.querySelectorAll(".editable").forEach(e=>e.classList.remove("active"));
    activeElement=null;
  }
});

function makeDraggable(el){
  interact(el).draggable({
    listeners:{
      move(event){
        el.dataset.x=parseFloat(el.dataset.x)+event.dx;
        el.dataset.y=parseFloat(el.dataset.y)+event.dy;
        updateTransform(el);
      }
    }
  });

  el.addEventListener("click",()=>activate(el));

  el.addEventListener("wheel",(e)=>{
    e.preventDefault();
    let scale=parseFloat(el.dataset.scale);
    scale += e.deltaY<0 ? 0.1 : -0.1;
    if(scale<0.2) scale=0.2;
    if(scale>5) scale=5;
    el.dataset.scale=scale;
    updateTransform(el);
  });
}

function updateTransform(el){
  el.style.transform=`
    translate(${el.dataset.x}px,${el.dataset.y}px)
    scale(${el.dataset.scale})
    rotate(${el.dataset.rotation}deg)
  `;
}

function deleteActive(){
  if(activeElement){
    activeElement.remove();
    activeElement=null;
  }
}

function clearCanvas(){
  canvas.innerHTML="";
}

/* ===== СОХРАНЕНИЕ ===== */

function saveOutfit(){
  if(canvas.innerHTML.trim()===""){
    alert("Добавьте элементы");
    return;
  }

  let outfit=[];
  document.querySelectorAll("#canvas .editable").forEach(el=>{
    outfit.push({
      src:el.querySelector("img").src,
      x:el.dataset.x,
      y:el.dataset.y,
      scale:el.dataset.scale,
      rotation:el.dataset.rotation
    });
  });

  savedOutfits.push(outfit);
  localStorage.setItem("outfits",JSON.stringify(savedOutfits));
  alert("Образ сохранён");
  renderCurrentOutfit();
}

/* ===== LOOKBOOK ===== */

function renderCurrentOutfit(){
  viewer.innerHTML="";
  if(savedOutfits.length===0){
    viewer.innerHTML="<p style='color:#777;text-align:center;margin-top:200px;'>Нет образов</p>";
    return;
  }

  let outfit=savedOutfits[currentIndex];

  outfit.forEach(item=>{
    const img=document.createElement("img");
    img.src=item.src;
    img.style.position="absolute";
    img.style.transform=`
      translate(${item.x}px,${item.y}px)
      scale(${item.scale})
      rotate(${item.rotation}deg)
    `;
    img.style.width="150px";
    viewer.appendChild(img);
  });
}

function prevOutfit(){
  if(savedOutfits.length===0) return;
  currentIndex--;
  if(currentIndex<0) currentIndex=savedOutfits.length-1;
  renderCurrentOutfit();
}

function nextOutfit(){
  if(savedOutfits.length===0) return;
  currentIndex++;
  if(currentIndex>=savedOutfits.length) currentIndex=0;
  renderCurrentOutfit();
}

renderCurrentOutfit();

</script>

</body>
</html>
